<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Knowledge Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.1.0/dist/echarts.min.js"></script>
</head>
<body>
<div id="chart" style="width: 800px; height: 600px;"></div>

<script type="text/javascript">
    fetch('/node_data')
        .then(response => response.json())
        .then(chartData => {
            var colorPalette = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];

            var chartDom = document.getElementById('chart');
            var myChart = echarts.init(chartDom);

            var nodes = chartData.nodes; // 节点数据

            // 创建关系字典，将节点 id 作为键，节点对象作为值
            var nodeDict = {};
            nodes.forEach(node => {
                nodeDict[node.id] = node;
            });

            // 创建关系数组，将连接线的 source 和 target 用节点对象代替
            var links = chartData.links.map(link => ({
                source: nodeDict[link.source],
                target: nodeDict[link.target]
            }));

            var option = {
                series: [
                    {
                        type: 'graph',
                        layout: 'force',
                        roam: true,
                        symbolSize: 50,
                        draggable: true,
                        label: {
                            show: true,
                            fontSize: 16,
                            formatter: function(params) {
                                return params.data.id;
                            }
                        },
                        edgeSymbol: ['none', 'none'],
                        edgeSymbolSize: [0, 0],
                        edgeLabel: {
                            fontSize: 12
                        },
                        data: nodes,
                        links: links,
                        emphasis: {
                            focus: 'adjacency',
                            lineStyle: {
                                width: 10
                            }
                        },
                        force: {
                            repulsion: 1000,
                            edgeLength: [80, 160],
                            layoutAnimation: true
                        },
                        lineStyle: {
                            curveness: 0.2
                        },
                        itemStyle: {
                            color: function(params) {
                                return colorPalette[params.data.group % colorPalette.length];
                            }
                        }
                    }
                ]
            };

            // 监听节点拖拽事件
            myChart.on('drag', function(params) {
                var draggedNode = params.nodes[0]; // 拖拽的节点 id
                var draggedNodeObj = nodeDict[draggedNode]; // 拖拽的节点对象
                var draggedGroup = draggedNodeObj.group; // 拖拽的节点群组

                // 遍历相关节点，将他们的位置设置为与拖拽节点相同
                nodes.forEach(node => {
                    if (node.group === draggedGroup && node.id !== draggedNode) {
                        node.x = draggedNodeObj.x;
                        node.y = draggedNodeObj.y;
                    }
                });

                myChart.setOption({ series: [{ data: nodes }] });
            });

            myChart.setOption(option);
        });
</script>
</body>
</html>